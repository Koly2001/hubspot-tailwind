const path = require('path');

function codeInjectionPlugin(options = {}) {
  const { file, root = process.cwd() } = options;
  return {
    name: 'ui-extensions-code-injection-plugin',
    enforce: 'post', // run after default rollup plugins
    transform(code, fileBeingTransformed) {
      const absoluteFilePath = path.isAbsolute(file)
        ? file
        : path.join(root, file);

      if (fileBeingTransformed !== absoluteFilePath) {
        return { code, map: null }; // Not the file we care about, return the same code
      }

      // Update the code to import the self script which houses our overrides
      // This needs to be the first line in the source file so that the overrides get hoisted
      // to the top of the generated source file
      const updatedCode = `import "@hubspot/ui-extensions-dev-server/self"; ${code}`;

      // Return the updated source code.  We don't need to include the new code in the
      // sourcemap because we don't want it to show up in the users code when they
      // view the source mapped code in the browser
      return { code: updatedCode, map: null };
    },
  };
}

module.exports = codeInjectionPlugin;
