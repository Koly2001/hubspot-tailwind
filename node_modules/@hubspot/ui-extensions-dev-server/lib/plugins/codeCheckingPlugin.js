const fs = require('fs');
const { logger } = require('@hubspot/cli-lib/logger');

function codeCheckingPlugin(options = {}) {
  const { output } = options;
  return {
    name: 'ui-extensions-code-checking-plugin',
    enforce: 'post',
    writeBundle(__options, __bundle) {
      try {
        const code = fs.readFileSync(output).toString();
        if (
          !code.includes('const extend = (...args) => self.extend(...args);')
        ) {
          logger.warn(
            'Unable to determine if your extension entry point is calling hubspot.extend, this may prevent it from rendering as expected'
          );
        }
      } catch (e) {
        logger.error('Unable to load bundle for code checking');
      }
    },
  };
}

module.exports = codeCheckingPlugin;
