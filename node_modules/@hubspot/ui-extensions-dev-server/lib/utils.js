const path = require('path');
const fs = require('fs');
const { MANIFEST_FILE } = require('./constants');

function getUrlSafeFileName(filePath) {
  const { name } = path.parse(filePath);
  return encodeURIComponent(`${name}.js`);
}

// Strips ANSI color codes out of strings because we don't want to pass them to the browser
function stripAnsiColorCodes(stringWithColorCodes) {
  if (!stringWithColorCodes) {
    return null;
  }
  return stringWithColorCodes.replace(
    // eslint-disable-next-line no-control-regex
    /[\u001b][[]*([0-9]{1,4};?)*[m]/g,
    ''
  );
}

function loadManifest(outputDir, output) {
  try {
    return JSON.parse(
      fs.readFileSync(path.join(outputDir, `${output}-${MANIFEST_FILE}`))
    );
  } catch (e) {
    return {};
  }
}

module.exports = {
  getUrlSafeFileName,
  stripAnsiColorCodes,
  loadManifest,
};
